<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Midwestern Region Economic Mobility</title>
  <meta name="description" content="Midwestern Region Economic Mobility">
  <meta name="author" content="Frey Hargarten - StarTribune">

  <link rel="stylesheet" href="../_common_resources/styles/startribune_dataviz_styles.css" />
  <link href="../_common_resources/charts/nvd3-master/build/nv.d3.css" rel="stylesheet" type="text/css">
  
  <style>
   #wrapper { text-align:center; height:auto; width:800px; margin-right:auto; margin-left:auto; }
   #map, #country { width:800px; margin-right:auto; margin-left:auto; text-align:center;  }
   #mapMN { width:350px; margin-right:auto; margin-left:auto; text-align:center;  }
   #leftSide {  }
   #rightSide {  }
   .none { fill:#ddd !important; }
   .zoom { float:none !important; text-align:center; padding:20px; }
   #slider { display:none; }
   .legends { width:318px; height:auto; text-align:center; margin-right:auto; margin-left:auto; }

   .metroSwitch { padding:10px; display:inline-block; text-align:center; width:49.5% !important; background-color:#fff; font-weight:900; font-family:"Benton Sans",Helvetica,Arial,sans-serif; border:1px solid black; }
   .metroSwitch:hover { background-color:#333 !important; color:#fff !important; cursor:pointer; }
   #map, #mapMN { display:none; }

   .tableHead { display:inline-block; padding:10px; border-bottom:1px solid #ddd; width:32%; font-weight:900; font-family:"Poynter Serif RE"; }
   .tableCell { display:inline-block; padding:10px; border-bottom:1px solid #ddd; width:32%; font-family:"Benton Sans"; }
   .tableBreak { clear:both; display:block; }
   .table { text-align:center; width:100%; overflow-x:hidden; overflow-y:auto; height:400px; }
   #filter input { border-radius:0 !important; }
   .district:hover, .selected, .hSort:hover, .start:hover { background-color:#333; color:#fff !important; cursor:pointer; }
   #quintile { float:left; width:20%; }
   #chartBlock { float:right; width:70%; }
   #chart { width:100%; height:190px; }

   .card { width:100% !important; height:auto !important; border:0 !important; padding:0 !important; display:block !important; }
   .card:hover { opacity:1 !important; cursor:default !important; }

   .chatter, .chartTitle { text-align:left; }

   .negDark { fill:#7F0000 !important; background-color:#7F0000 !important; color:#fff !important; }
   .negMid { fill:#F24930 !important; background-color:#F24930 !important; color:#fff; }
   .negLight { fill:#FED98E !important; background-color:#FED98E !important; }
   .neutral { fill:#ddd !important; background-color:#fff !important; }
   .posLight { fill:#ECF9B9 !important; background-color:#ECF9B9 !important; }
   .posMid { fill:#AEDE8F !important; background-color:#AEDE8F !important; color:#fff; }
   .posDark { fill:#0F6633 !important; background-color:#0F6633 !important; color:#fff !important; } 

   .state-boundary { fill: none; stroke: #fff; stroke-width:2.3px; } 

   path:hover { cursor:normal !important; } 

   #mapChatter { display:none; } 

   .city-label { font-size:8px !important; margin-left:3px !important; text-anchor:left !important; } 

   small { font-family:"Benton Sans",Helvetica,Arial,sans-serif; color:#808080; clear:both; display:block; } 

   .grid { padding:10px; }
   #gridBlock   { float:right; width:47%; }
   #tableBlock { float:left; display:inline-block; width:47%; }
  #districtName { display:none; }

    #tableBlock, #gridBlock, #quintile, #chartBlock, #chart { width:100%; float:none; display:block !important; }
    .metroSwitch { width:32%; }

   @media (max-width:800px) {
    #map, #country { width:100%; }
    #wrapper { width:100%; }
   }
  </style> 
</head>

<body>
  <div id="wrapper">

<!-- <div class="chartTitle">Title</div>
<div class="chatter">chatter</div>
<div class="breaker"></div> -->

<div id="viewSwitch"><div class="metroSwitch selected" id="usfilter" data="country">National</div> <div class="metroSwitch" id="mwfilter" data="map">Midwest</div> <!-- <div class="metroSwitch" data="mapMN">MN</div> --> 

<div class="chatter" id="countryChatter">The Upper Midwest has been the bestplace in the country for upward mobility in the last 30 years, and the Deep South is the worst.</div>
<div class="chatter" id="mapChatter">In the Midwest, the states west of the Mississippi offer the most opportunity to children from lower-income families, but even  in Minnesota, Iowa, Nebraska and the Dakotas, large urban centers rank well below rural areas.</div>

<div id="leftSide">
<div id="map" class="map"><svg width="800" height="500" viewBox="0 0 800 500" preserveAspectRatio="xMidYMid"></svg></div>
<div id="mapMN" class="map"><svg width="100%" height="500" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
<div id="country" class="map"><svg width="800" height="500" viewBox="0 0 800 500" preserveAspectRatio="xMidYMid"></svg></div>
</div>

<div class="breaker"></div>

<div class="zoom">Reset View</div></div>

<div class="legendBox">
<div class="legends">
    <div class="legendContainer">
      <span class='legend'>
        <nav class='legend clearfix'>
          <span style='background:#fff;'>-20</span>
          <span class='negDark'></span>
          <span class='negMid'></span>
          <span class='negLight'></span>
          <span class='neutral'></span>
          <span class='posLight'></span>
          <span class='posMid'></span>
          <span class='posDark'></span>
          <span style='background:#fff;'>+20</span>
        </nav>
      </span>
    </div>
    <small>Points above/below average upward mobility</small>
  </div>
</div>

<div class="breaker"></div>

<div id="rightSide">
<div id="districtName" style="display:none;">Midwest</div>

<div id="tableBlock">
<!-- <h3>Someone growing up in</h3> -->
<div id="filter" class="filter"><input type="search" class="filter_box" placeholder="Search by county or state"></input></div>
<div class="table" id="table">
<div class='tableHead partyBar hSort' data="county">County</div><div class='tableHead hSort selected' data="state">State</div>
<div class='tableHead hSort' data="aum25">AUM</div>
</div>
</div>

<!-- <div id="gridBlock" style="display:none;">  
<h3 style="text-align:left;">...with parents earning in the <span id="pQ">--</span> quintile</h3> 
<div id="quintile">
<div class="grid start" data="p5">5th</div>
<div class="grid start" data="p4">4th</div>
<div class="grid start" data="p3">3rd</div>
<div class="grid start" data="p2">2nd</div>
<div class="grid start selected" data="p1">1st</div>
</div>
<div id="chartBlock">
<div id="chart"><svg></svg></div>
</div>
<div class="breaker"></div>
<h3 style="text-align:right;">...end up on average in the <span id="cQ">--</span> quintile</h3>
</div> -->
</div>

  </div>


  </div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="../_common_resources/charts/nvd3-master/build/nv.d3.js"></script>
<script src="../_common_resources/charts/nvd3-master/src/utils.js"></script>
<script src="../_common_resources/charts/nvd3-master/src/tooltip.js"></script>
<script src="../_common_resources/charts/nvd3-master/src/models/legend.js"></script>
<script src="../_common_resources/charts/nvd3-master/src/models/axis.js"></script>
<script src="../_common_resources/charts/nvd3-master/test/stream_layers.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>

<script>
//http://www.nytimes.com/2013/07/22/business/in-climbing-income-ladder-location-matters.html?pagewanted=all
//http://bl.ocks.org/d3noob/c9b90689c1438f57d649

</script>
<script>
var toggle = "p1";

$(".metroSwitch").click(function() {
  $(".metroSwitch").removeClass("selected");
  $(this).addClass("selected");
  $(".map").hide();
  $(".chatter").hide();
  $("#" + $(this).attr("data")).show();
  $("#" + $(this).attr("data") + "Chatter").show();
});

//LIVE JSON MAGIC

//https://script.google.com/macros/s/AKfycbwG7mX6qPZaIhkwY2AJ2lU7kNarbm6OWIkWVfnmYZGYruIl40cu/exec?id=1IA2b2UwsXVyxSN-vyF1wQh12dJjmeB2LzJUK54Mt7qY&sheet=countiesAll

//https://script.google.com/macros/s/AKfycbwG7mX6qPZaIhkwY2AJ2lU7kNarbm6OWIkWVfnmYZGYruIl40cu/exec?id=1RiNtORVIispxDGDxtdDljvs0CEDP94EaV2B3wbcMkXk&sheet=events

d3.json("https://script.googleusercontent.com/macros/echo?user_content_key=Iiu7d5v7uTzA3A8rDzVrgIny3eTE8z8jaPvVyu04yib0bfX4MpnA0IEMtzTg2qpCFyrWiHjphI6f_UZO-CDZotNiCpgau37DOJmA1Yb3SEsKFZqtv3DaNYcMrmhZHmUMWojr9NvTBuBLhyHCd5hHaxCoMjMSmZWLp6XAShvjQj50JtCfh4yP7n1RnEoDeOH7XqmOXgX8RYIyMAhIAtjnF9UDzNXGLr6TBNazkN1LwDkRgliZDyKih_Q8eB04lcAX-r6YpSSA6aP54X-URYOTRFs3Us1YSAyaW0Ar8EAym2_s8cJgq7PpvZlqkDfXKzXo&lib=MVcLnEUipyThKZcpmQKyqT_CoSfd4egCX", function(error, json) {

var data = json.countiesAll;

var aspect = 800 / 500, chart = $("#map svg");
var aspect2 = 800 / 500, chart2 = $("#country svg");

var midwestLoad = false;

$(window).on("resize", function() {   
  var targetWidth = chart.parent().width();   
  var targetWidth2 = chart2.parent().width(); 
  chart.attr("width", targetWidth);   
  chart.attr("height", targetWidth / aspect);
  chart2.attr("width", targetWidth2);   
  chart2.attr("height", targetWidth2 / aspect2);
});

$(".hSort").click(function() {
  $(".hSort").removeClass("selected");
  $(this).addClass("selected");
  if ($(this).hasClass("toggled")) { $(this).removeClass("toggled"); var sorted = "ascend"; }
  else if ($(this).hasClass("selected")) { $(this).addClass("toggled"); var sorted ="descend"; } 
  tableSort("#table",data,$(this).attr("data"),sorted);
});

$(".district").click(function() {
  $(".district").removeClass("selected");
  $(this).addClass("selected");
});


//SELECTION TABLES
function tableSort(container,data,column,sorted){
   
  d3.select(container).selectAll(".card").sort(function(a, b) {
          if (column == "county") { 
        if (sorted == "descend") { return d3.descending(a.county, b.county); }
        if (sorted == "ascend") { return d3.ascending(a.county, b.county); }
     }
          if (column == "state") { 
        if (sorted == "descend") { return d3.descending(a.state, b.state); }
        if (sorted == "ascend") { return d3.ascending(a.state, b.state); }
     }
          if (column == "aum25") { 
        if (sorted == "descend") { return d3.descending(a.aum25, b.aum25); }
        if (sorted == "ascend") { return d3.ascending(a.aum25, b.aum25); }
     }
          if (column == "aum75") { 
        if (sorted == "descend") { return d3.descending(a.aum75, b.aum75); }
        if (sorted == "ascend") { return d3.ascending(a.aum75, b.aum75); }
     }
    })
    .transition().duration(500);
}

function tableBuild(container,data,index){

d3.select(container).selectAll(".card")
.data(data).enter().append("div")
.attr("class","card")
.attr("fips",function (d){ return d.FIPS; })
.html(function (d){
  var p25, p75 = 0;

  if (d.aum25 != 0) { 
    p25 = d3.format("+")(Math.round(d.aum25 - 42)); 
    p75 = d3.format("+")(Math.round(d.aum75 - 61)); 
  } 
  else { 
    p25 = "No data available"; 
    p75 = "No data available"; 
  }
  
  // return "<div class='tableCell district' data='county'>" + d.county + "</div><div class='tableCell' data='state'>" + d.state + "</div>";

  return "<div class='tableCell district' data='county'>" + d.county + "<span style='display:none'>" + d.FIPS + "</span></div><div class='tableCell state' data='state'>" + d.state + "</div><div class='tableCell p25'>" + p25 + "</div>";
});

//SEARCH        
        var sd = "South Dakota";
        var nd = "North Dakota";
        var mn = "Minnesota";
        var ia = "Iowa";
        var wi = "Wisconsin";
        var il = "Illinois";
        var ind = "Indiana";
        var mi = "Michigan";
        var oh = "Ohio";

$( document ).ready(function() {
     $('#filter input').keyup(function(i){
        
        $('.card, .card div').hide();
        var txt = $('#filter input').val();
        if (txt == ""){ $('.card, .card div').show(); } 
        else {
        if (midwestLoad == false){
        $('.card').each(function(){
           if($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1){
               $(this).show();
               $(this).find("div").show();
           }
        });
      } else {
            $('.state').each(function(){
           if($(this).text().toUpperCase().indexOf(txt.toUpperCase() || $(this).text().toUpperCase().indexOf(sd.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(nd.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(mn.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(ia.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(wi.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(il.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(ind.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(mi.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(oh.toUpperCase()) != -1) != -1){
               $(this).parent().show();
               $(this).parent().find("div").show();
           }
        });
      }
    }
    });

$("#usfilter").click(function() {
  midwestLoad = false;
 $('.card, .card div').show();
})

$("#mwfilter").click(function() {
    midwestLoad = true;
    $('.card, .card div').hide();
        $('.state').each(function(){
           if($(this).text().toUpperCase().indexOf(sd.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(nd.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(mn.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(ia.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(wi.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(il.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(ind.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(mi.toUpperCase()) != -1 || $(this).text().toUpperCase().indexOf(oh.toUpperCase()) != -1){
               $(this).parent().show();
               $(this).parent().find("div").show();
      }
});
        });
  });

$(".district").click(function() {
 $(".district").removeClass("selected");
 $(this).addClass("selected");

  $(".districtName").html($(this).text());

  jQuery.fn.d3Click = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};

jQuery.fn.d3Down = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("mousedown", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};

jQuery.fn.d3Up = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("mouseup", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};

    // clicked2();
    var findDistrict = ($(this).text() + "_us").replace(new RegExp(" ", "g"),"-");
    var findDistrictMN = ($(this).text() + "_mn").replace(new RegExp(" ", "g"),"-");
    var findDistrictMW = ($(this).text() + "_country").replace(new RegExp(" ", "g"),"-");

    $("[id='" + findDistrict.replace(new RegExp(" ", "g"),"-") + "']").d3Down();
    $("[id='" + findDistrict.replace(new RegExp(" ", "g"),"-") + "']").d3Up();
    $("[id='" + findDistrict.replace(new RegExp(" ", "g"),"-") + "']").d3Click();
    // $("[id='" + findDistrictMN.replace(new RegExp(" ", "g"),"-") + "']").d3Down();
    // $("[id='" + findDistrictMN.replace(new RegExp(" ", "g"),"-") + "']").d3Up();
    // $("[id='" + findDistrictMN.replace(new RegExp(" ", "g"),"-") + "']").d3Click();
    $("[id='" + findDistrictMW.replace(new RegExp(" ", "g"),"-") + "']").d3Down();
    $("[id='" + findDistrictMW.replace(new RegExp(" ", "g"),"-") + "']").d3Up();
    $("[id='" + findDistrictMW.replace(new RegExp(" ", "g"),"-") + "']").d3Click();
});

   $('.p25').each(function() {
    var num = $(this).text();
    if (num != "No data available"){
      var color_scale = d3.scale.linear().domain([-20, 0, 25]).range(['#7F0000', '#ECF9B9', '#0F6633']);
      if (num < -15 || num > 15) { var textcolor = "#fff"; }
      else  { var textcolor = "#000"; }
      $(this).css('color', textcolor);
      $(this).css('background-color', color_scale(num));
     
    }
    });
   $('.p75').each(function() {
    var num = $(this).text();
    if (num != "No data available"){
      if (num >= 20) { $(this).addClass("posDark"); $(this).html(num); }
      else if (num >= 10) { $(this).addClass("posMid"); $(this).html(num); } 
      else if (num > 0) { $(this).addClass("posLight"); $(this).html(num); }
      else if (num <= -20) { $(this).addClass("negDark"); $(this).html(num); }
      else if (num <= -10) { $(this).addClass("negMid"); $(this).html(num); }
      else if (num < 0) { $(this).addClass("negLight"); $(this).html(num); }
      else if (num == 0) { $(this).addClass("neutral"); $(this).html(num); }
    }
    });
}


//MAPS
function mapReshade(container, shape, subject, race, dataCompare, visible, demoData, demoData2) {
d3.selectAll(container + " svg g path")
      .data(us.features)
      .style("opacity",visible)
      .attr("class", function(d){
        return "orange2";
        });
}

function mapColor(d, subject, dataCompare){
  for (var i=0; i < data.length; i++){
    if (d.properties.GEOID == data[i].FIPS || ("27" + String(d.properties.COUNTYFIPS)) == String(data[i].FIPS)){
      var points = data[i].aum25 - 42;
      if (data[i].aum25 == null || data[i].aum25 == 0 || data[i].aum25 == "undefined") { return "#fff"; }
      else { 
        var color_scale = d3.scale.linear().domain([-20, 0, 25]).range(['#7F0000', '#ECF9B9', '#0F6633']);
        return color_scale(points);
      }

      // break;
      // else if (points >= 15 ) { return "posDark"; }
      // else if (points >= 10) { return "posMid"; }
      // else if (points > 0) { return "posLight"; }
      // else if (points <= -15) { return "negDark"; }
      // else if (points <= -10) { return "negMid"; }
      // else if (points < 0) { return "negLight"; }
      // break;
      // return color_scale(d['properties']['CENSUSAREA']);
    }
  }
    return "#fff";
}

function mapTips(d, subject, dataCompare){
  for (var i=0; i < data.length; i++){
    if (d.properties.GEOID == data[i].FIPS || ("27" + String(d.properties.COUNTYFIPS)) == String(data[i].FIPS)){
      if (data[i].aum25 != 0) { 
       if (d.properties.hasOwnProperty('NAME')) { var name = d.properties.NAME; }
       else if (d.properties.hasOwnProperty('COUNTYNAME')) { var name = d.properties.COUNTYNAME; }
        var points = Math.round(data[i].aum25 - 47); 
        if (Math.round(data[i].aum25) < -15 || Math.round(data[i].aum25) > 15) { var textcolor = "#fff"; }
        else  { var textcolor = "#000"; }
        return "<div style='font-weight:900;'>" + name + " County, " + data[i].state + "</div><div>" + Math.round(data[i].aum25) + " average upward mobility score</div><div style='background-color:" + mapColor(d, subject, dataCompare) + "; color:" + textcolor + "'>" + d3.format("+")(points) + " from average</div>";
      } else {
         return "<div style='font-weight:900;'>" + d.properties.NAME + " County, " + data[i].state + "</div><div>No data available</div>";
      }
    }
  }
}

function mapBuild(container, boxContainer, chartContainer, shape, race, geo, dataCompare, index, visible) {

if (geo=="country") { var width = 800, height = 500, centered; var projection = d3.geo.albersUsa().scale(1000).translate([400, 260]); }
else if (geo=="us") { var width = 800, height = 500, centered; var projection = d3.geo.albersUsa().scale(2000).translate([330, 430]); }
else if (geo=="mn") { var width = 350, height = 500, centered; var projection = d3.geo.albersUsa().scale(5037).translate([50, 970]); }
else if (geo=="metro") { var width = 350, height = 350, centered; var projection = d3.geo.mercator().scale([16500]).center([-92.403259,44.988113]); }

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select(container + " svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height);

var g = svg.append("g");

d3.json("shapefiles/" + shape, function(error, us) {
d3.json("shapefiles/us_states_topo.json", function(error, st) {

  var marks = [{long:-93.266667, lat:44.983333, name:"Minneapolis"},{long:-74.0059, lat:40.7127, name:"New York"},{long: -122.416667, lat: 37.783333, name:"San Francisco"},{long: -87.955833, lat: 43.052222, name:"Milwaukee"},{long: -87.684722, lat: 41.836944, name:"Chicago"},{long: -93.620833, lat: 41.590833, name:"Des Moines"},{long: -83.045833, lat: 42.331389, name:"Detroit"},{long: -86.15, lat: 39.766667, name:"Indiana"},{long: -96.731667, lat: 43.536389, name:"Sioux Falls"},{long: -118.25, lat: 34.05, name:"Los Angeles"},{long: -80.208889, lat: 25.775278, name:"Miami"},{long: -95.383056, lat: 29.762778, name:"Houston"},{long: -96.796667, lat: 32.775833, name:"Dallas"},{long: -71.063611, lat: 42.358056, name:"Boston"}];

  g.append("g")
      .attr("class", "states")
    .selectAll("path")
      .data(us.features)
    .enter().append("path")
      .attr("d", path)
      .on("click", clicked)
      .attr("id", function(d) { var str = d.properties.NAME + "" + d.properties.GEOID + "_" + geo; return str.replace(new RegExp(" ", "g"),"-"); })
      .style("fill", function(d){
         return mapColor(d, race, dataCompare);
      })
      .on("mousedown", function(d, i){
        for (var i=0; i < data.length; i++){
        if (d.properties.GEOID == data[i].FIPS || ("27" + String(d.properties.COUNTYFIPS)) == String(data[i].FIPS)){
          $("#districtName").html(d.properties.NAME + " County, " + data[i].state);
        
        if (d.properties.hasOwnProperty('NAME')) { var name = d.properties.NAME; var state = data[i].state; }
        else if (d.properties.hasOwnProperty('COUNTYNAME')) { var name = d.properties.COUNTYNAME; var state = "Minnesota";  }

        var txt = name;
        var txt2 = state;
        $('.card, .card div').hide();
        $('.card').each(function(){
           if($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1 && $(this).text().toUpperCase().indexOf(txt2.toUpperCase()) != -1){
               $(this).show();
               $(this).find("div").show();
           }
          })
        }
      }
      })
      .style("stroke-width", ".5px")
      .style("stroke", "#fff")
      .call(d3.helper.tooltip(function(d, i){
        return mapTips(d, race, dataCompare);
      }));

  g.append("path")
      //.datum(topojson.mesh(us, us.features, function(a, b) { return a !== b; }))
      .attr("id", "state-borders")
      .attr("d", path);

  svg.selectAll("circle")
    .data(marks)
    .enter()
    .append("circle")
    .attr('class','mark')
    .attr('width', 10)
    .attr('height', 10)
    .attr("r", "1.3px")
    .attr("fill", "#333")
    .attr("transform", function(d) {return "translate(" + projection([d.long,d.lat]) + ")";});

    svg.insert("path", ".graticule")
      .datum(topojson.mesh(st, st.objects.us_states, function(a, b) { return a !== b; }))
      .attr("class", "state-boundary")
      .style("stroke-width", "1.2px")
      .attr("d", path);

  svg.selectAll("text")
    .data(marks)
    .enter()
    .append("text")
    .attr('class','city-label')
    .attr("transform", function(d) {return "translate(" + projection([d.long+.23,d.lat-.09]) + ")";})
    .text(function(d) { return " " + d.name; });



});
});

var zoom = d3.behavior.zoom()
    .on("zoom",function() {
        g.attr("transform","translate("+ 
            d3.event.translate.join(",")+")scale("+d3.event.scale+")");
        g.selectAll("circle")
            .attr("d", path.projection(projection));
        g.selectAll("path")  
            .attr("d", path.projection(projection)); 

  });

$(".zoom").click(function() {
  clicked2();
  $('#filter input').val("");
  $("#districtName").html("Midwest");
  $(".district").removeClass("selected");
  $('.card, .card div').show();
});

function clicked(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 6;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 3;
    centered = null;
  }

  g.selectAll("path")
      .classed("faded", true)
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      // .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");
}

function clicked2(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 1;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("faded", false)
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      // .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");
}

d3.helper = {};

d3.helper.tooltip = function(accessor){
    return function(selection){
        var tooltipDiv;
        var bodyNode = d3.select('body').node();
        selection.on("mouseover", function(d, i){
            // Clean up lost tooltips
            d3.select('body').selectAll('div.tooltip').remove();
            // Append tooltip
            tooltipDiv = d3.select('body').append('div').attr('class', 'tooltip');
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px')
                .style('position', 'absolute') 
                .style('z-index', 1001);
            // Add text using the accessor function
            var tooltipText = accessor(d, i) || '';
            // Crop text arbitrarily
            //tooltipDiv.style('width', function(d, i){return (tooltipText.length > 80) ? '300px' : null;})
            //    .html(tooltipText);
        })
        .on('mousemove', function(d, i) {
            // Move tooltip
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px');
            var tooltipText = accessor(d, i) || '';
            tooltipDiv.html(tooltipText);
        })
        .on("mouseout", function(d, i){
            // Remove tooltip
            tooltipDiv.remove();
        });

    };
};

}

function redrawChart(chart,container,subject,data,county,index,year){
  var colorArray = ['#777','#C22A22']; 
  var formatter = d3.format('%');

    d3.select(container + ' svg').datum(chartData(subject,data,county,year)).transition().duration(300).call(chartStuff[index].color(colorArray));
    // chart[index].yAxistickFormat(formatter);
    nv.utils.windowResize(chartStuff[index].update);

}

function chartData(subject,data,county,level) {

 var cq1_pq1, cq2_pq1, cq3_pq1, cq4_pq1, cq5_pq1, cq1_pq2, cq2_pq2, cq3_pq2, cq4_pq2, cq5_pq2, cq1_pq3, cq2_pq3, cq3_pq3, cq4_pq3, cq5_pq3, cq1_pq4, cq2_pq4, cq3_pq4, cq4_pq4, cq5_pq4, cq1_pq5, cq2_pq5, cq3_pq5, cq4_pq5, cq5_pq5 = 0;

  for (var i=0; i<data.length; i++){
    if (data[i].FIPS == county){
      cq1_pq1 = data[i].cq1_pq1;
      cq2_pq1 = data[i].cq2_pq1;
      cq3_pq1 = data[i].cq3_pq1;
      cq4_pq1 = data[i].cq4_pq1;
      cq5_pq1 = data[i].cq5_pq1;
      cq1_pq2 = data[i].cq1_pq2;
      cq2_pq2 = data[i].cq2_pq2;
      cq3_pq2 = data[i].cq3_pq2;
      cq4_pq2 = data[i].cq4_pq2;
      cq5_pq2 = data[i].cq5_pq2;
      cq1_pq3 = data[i].cq1_pq3;
      cq2_pq3 = data[i].cq2_pq3;
      cq3_pq3 = data[i].cq3_pq3;
      cq4_pq3 = data[i].cq4_pq3;
      cq5_pq3 = data[i].cq5_pq3;
      cq1_pq4 = data[i].cq1_pq4;
      cq2_pq4 = data[i].cq2_pq4;
      cq3_pq4 = data[i].cq3_pq4;
      cq4_pq4 = data[i].cq4_pq4;
      cq5_pq4 = data[i].cq5_pq4;
      cq1_pq5 = data[i].cq1_pq5;
      cq2_pq5 = data[i].cq2_pq5;
      cq3_pq5 = data[i].cq3_pq5;
      cq4_pq5 = data[i].cq4_pq5;
      cq5_pq5 = data[i].cq5_pq5;
      break;
    }
  };

if (toggle == "p1"){
  var pct1 = cq1_pq1;
  var pct2 = cq2_pq1;
  var pct3 = cq3_pq1;
  var pct4 = cq4_pq1;
  var pct5 = cq5_pq1;  
}
else if (toggle == "p2"){
  var pct1 = cq1_pq2;
  var pct2 = cq2_pq2;
  var pct3 = cq3_pq2;
  var pct4 = cq4_pq2;
  var pct5 = cq5_pq2;  
}
else if (toggle == "p3"){
  var pct1 = cq1_pq3;
  var pct2 = cq2_pq3;
  var pct3 = cq3_pq3;
  var pct4 = cq4_pq3;
  var pct5 = cq5_pq3;  
}
else if (toggle == "p4"){
  var pct1 = cq1_pq4;
  var pct2 = cq2_pq4;
  var pct3 = cq3_pq4;
  var pct4 = cq4_pq4;
  var pct5 = cq5_pq4;  
}
else if (toggle == "p5"){
  var pct1 = cq1_pq5;
  var pct2 = cq2_pq5;
  var pct3 = cq3_pq5;
  var pct4 = cq4_pq5;
  var pct5 = cq5_pq5;  
}


  return [{
        "key": "PCT",
        "values": [
          { 
            "label" : "5th" ,
            "value" : pct5
          },
          { 
            "label" : "4th" ,
            "value" : pct4
          },
          { 
            "label" : "3rd" ,
            "value" : pct3
          },
          { 
            "label" : "2nd" ,
            "value" : pct2
          },
          { 
            "label" : "1st" ,
            "value" : pct1
          }]
      }]

}

  tableBuild("#table",data,0)

  mapBuild("#map", "#districtName", "#chart", "us_states.json", "economics", "us", data, 2, 1);
  mapBuild("#map", "#districtName", "#chart", "midwest_counties.json", "economics", "us", data, 2, 1);
  // mapBuild("#mapMN", "#districtName", "#chart", "counties.json", "economics", "mn", data, 2, 1);
  mapBuild("#country", "#districtName", "#chart", "us_counties.json", "economics", "country", data, 2, 1);

  var targetWidth = chart.parent().width();   
  chart.attr("width", targetWidth);
  chart.attr("height", targetWidth / aspect);
  var targetWidth2 = chart2.parent().width();   
  chart2.attr("width", targetWidth2);
  chart2.attr("height", targetWidth2 / aspect2);

});
</script>

</html>
